/**
 * Tournament Selector
 * Provides UI controls to discover, select, and load different tournament versions
 */

// Tournament Selector State
let availableTournaments = [];
let currentTournamentPath = null;

/**
 * Discover available tournaments in var/tournaments/ directory
 * @returns {Promise<Array>} Array of tournament metadata objects
 */
async function discoverTournaments() {
    try {
        // Fetch tournament manifest (generated by generate_tournament_manifest.py)
        const response = await fetch('var/tournaments/manifest.json');
        if (!response.ok) {
            console.warn('Could not load tournament manifest (var/tournaments/manifest.json)');
            console.warn('Run: uv run python generate_tournament_manifest.py');
            return [];
        }

        const manifest = await response.json();
        const tournaments = [];

        // Process tournaments from manifest
        for (const t of manifest.tournaments) {
            const timestamp = t.timestamp;
            tournaments.push({
                filename: t.filename,
                path: t.path,
                timestamp: timestamp,
                displayName: formatTournamentName(timestamp)
            });
        }

        console.log(`Discovered ${tournaments.length} tournament(s):`, tournaments);
        return tournaments;
    } catch (error) {
        console.error('Error discovering tournaments:', error);
        console.error('Make sure to run: uv run python generate_tournament_manifest.py');
        return [];
    }
}

/**
 * Format tournament timestamp as human-readable name
 * @param {string} timestamp - Format: YYYYMMDD_HHMMSS
 * @returns {string} Formatted name like "2025-12-12 19:21"
 */
function formatTournamentName(timestamp) {
    const date = timestamp.substring(0, 8);
    const time = timestamp.substring(9, 15);

    const year = date.substring(0, 4);
    const month = date.substring(4, 6);
    const day = date.substring(6, 8);
    const hour = time.substring(0, 2);
    const minute = time.substring(2, 4);

    return `${year}-${month}-${day} ${hour}:${minute}`;
}

/**
 * Initialize tournament selector UI
 * Discovers tournaments and populates dropdown
 */
async function initTournamentSelector() {
    const selector = document.getElementById('tournament-selector');
    if (!selector) {
        console.warn('Tournament selector element not found');
        return;
    }

    // Discover available tournaments
    availableTournaments = await discoverTournaments();

    if (availableTournaments.length === 0) {
        selector.innerHTML = '<option value="">No tournaments found</option>';
        updateTournamentInfo(null);
        return;
    }

    // Populate dropdown
    selector.innerHTML = '';
    availableTournaments.forEach((tournament, index) => {
        const option = document.createElement('option');
        option.value = tournament.path;
        option.textContent = `${tournament.displayName}${index === 0 ? ' (Latest)' : ''}`;
        selector.appendChild(option);
    });

    // Set initial selection to latest
    if (availableTournaments.length > 0) {
        selector.value = availableTournaments[0].path;
        currentTournamentPath = availableTournaments[0].path;
        // Info will be updated after tournament loads via initTournamentLoader
    }

    // Handle selection changes
    selector.addEventListener('change', async (e) => {
        const selectedPath = e.target.value;
        if (selectedPath && selectedPath !== currentTournamentPath) {
            console.log(`Switching to tournament: ${selectedPath}`);
            currentTournamentPath = selectedPath;
            await loadSelectedTournament(selectedPath);
        }
    });

    console.log('Tournament selector initialized');
}

/**
 * Load a selected tournament and update UI
 * @param {string} tournamentPath - Path to tournament JSON file
 */
async function loadSelectedTournament(tournamentPath) {
    // Check if tournament loader is available
    if (typeof tournamentLoader === 'undefined' || !tournamentLoader) {
        console.error('Tournament loader not initialized');
        return;
    }

    console.log(`Loading tournament from: ${tournamentPath}`);

    // Load the selected tournament
    const tournamentData = await tournamentLoader.loadTournament(tournamentPath);

    if (tournamentData) {
        console.log('Tournament loaded successfully:', tournamentData);

        // Update the info display
        updateTournamentInfo(tournamentPath);

        // Re-apply tournament data to leaderboard
        if (typeof LLMS !== 'undefined' && typeof leaderboard !== 'undefined' && typeof updateLeaderboardUI !== 'undefined') {
            if (typeof updateLeaderboardWithTournamentData === 'function') {
                updateLeaderboardWithTournamentData(LLMS, leaderboard, updateLeaderboardUI);
            }
        }

        // Update the tournament stats panel
        if (typeof showTournamentStats === 'function') {
            showTournamentStats();
        }
    } else {
        console.error('Failed to load tournament');
    }
}

/**
 * Update tournament info display in selector panel
 * @param {string} tournamentPath - Path to current tournament file (or null)
 */
function updateTournamentInfo(tournamentPath) {
    const warriorsEl = document.getElementById('tournament-warriors');
    const matchupsEl = document.getElementById('tournament-matchups');
    const dateEl = document.getElementById('tournament-date');

    if (!warriorsEl || !matchupsEl || !dateEl) {
        return;
    }

    // Reset if no tournament
    if (!tournamentPath || typeof tournamentLoader === 'undefined' || !tournamentLoader || !tournamentLoader.tournamentData) {
        warriorsEl.textContent = '-';
        matchupsEl.textContent = '-';
        dateEl.textContent = '-';
        return;
    }

    const data = tournamentLoader.tournamentData;

    // Update warriors count
    warriorsEl.textContent = data.warriors ? data.warriors.length : '-';

    // Update matchups count
    matchupsEl.textContent = data.matchups ? data.matchups.length : '-';

    // Update date
    if (data.timestamp) {
        const date = new Date(data.timestamp);
        dateEl.textContent = date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } else {
        // Parse from filename if timestamp not in data
        const match = tournamentPath.match(/tournament_(\d{8})_(\d{6})/);
        if (match) {
            const dateStr = match[1];
            const timeStr = match[2];
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const hour = timeStr.substring(0, 2);
            const minute = timeStr.substring(2, 4);

            dateEl.textContent = `${month}/${day} ${hour}:${minute}`;
        } else {
            dateEl.textContent = '-';
        }
    }
}

// Make functions and state available globally
window.initTournamentSelector = initTournamentSelector;
window.updateTournamentInfo = updateTournamentInfo;
Object.defineProperty(window, 'currentTournamentPath', {
    get: () => currentTournamentPath,
    set: (value) => { currentTournamentPath = value; }
});
